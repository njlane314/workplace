name: Sync individual repos

on:
  push:
    paths:
      - framework/**
      - macro_packs/default/**
      - .github/workflows/sync-individual-repos.yml
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-framework:
    runs-on: ubuntu-latest
    steps:
      - name: Check required configuration
        id: precheck
        env:
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
          REPO_NAME: ${{ secrets.FRAMEWORK_REPO != '' && secrets.FRAMEWORK_REPO || vars.FRAMEWORK_REPO }}
        run: |
          if [ -z "${TOKEN}" ] || [ -z "${REPO_NAME}" ]; then
            missing=()

            if [ -z "${TOKEN}" ]; then
              missing+=("SPLIT_REPO_TOKEN")
            fi

            if [ -z "${REPO_NAME}" ]; then
              missing+=("FRAMEWORK_REPO (secret or variable)")
            fi

            echo "Missing ${missing[*]}; skipping framework sync."
            echo "should_run=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "should_run=true" >> "${GITHUB_OUTPUT}"

      - name: Checkout monorepo
        if: steps.precheck.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Split and push framework history
        if: steps.precheck.outputs.should_run == 'true'
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          REPO_NAME: ${{ secrets.FRAMEWORK_REPO != '' && secrets.FRAMEWORK_REPO || vars.FRAMEWORK_REPO }}
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
        run: |
          set -euo pipefail
          split_sha="$(git subtree split --prefix=framework)"
          git push --force "https://x-access-token:${TOKEN}@github.com/${REPO_NAME}.git" "${split_sha}:refs/heads/${BRANCH_NAME}"

  sync-macros:
    runs-on: ubuntu-latest
    steps:
      - name: Check required configuration
        id: precheck
        env:
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
          MACROS_REPO: ${{ secrets.MACROS_REPO != '' && secrets.MACROS_REPO || vars.MACROS_REPO }}
          DEPENDENCIES_REPO: ${{ secrets.DEPENDENCIES_REPO != '' && secrets.DEPENDENCIES_REPO || vars.DEPENDENCIES_REPO }}
        run: |
          if [ -z "${TOKEN}" ] || { [ -z "${MACROS_REPO}" ] && [ -z "${DEPENDENCIES_REPO}" ]; }; then
            missing=("SPLIT_REPO_TOKEN")

            if [ -n "${TOKEN}" ]; then
              missing=()
            fi

            if [ -z "${MACROS_REPO}" ] && [ -z "${DEPENDENCIES_REPO}" ]; then
              missing+=("MACROS_REPO or DEPENDENCIES_REPO (secret or variable)")
            fi

            echo "Missing ${missing[*]}; skipping macro sync."
            echo "should_run=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "should_run=true" >> "${GITHUB_OUTPUT}"

      - name: Checkout monorepo
        if: steps.precheck.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Split and push macro pack history
        if: steps.precheck.outputs.should_run == 'true'
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          REPO_NAME: ${{ (secrets.MACROS_REPO != '' && secrets.MACROS_REPO || vars.MACROS_REPO) != '' && (secrets.MACROS_REPO != '' && secrets.MACROS_REPO || vars.MACROS_REPO) || (secrets.DEPENDENCIES_REPO != '' && secrets.DEPENDENCIES_REPO || vars.DEPENDENCIES_REPO) }}
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
        run: |
          set -euo pipefail
          split_sha="$(git subtree split --prefix=macro_packs/default)"
          git push --force "https://x-access-token:${TOKEN}@github.com/${REPO_NAME}.git" "${split_sha}:refs/heads/${BRANCH_NAME}"
