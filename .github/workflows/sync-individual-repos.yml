name: Sync individual repos

on:
  push:
    paths:
      - framework/**
      - macro_packs/default/**
      - .github/workflows/sync-individual-repos.yml
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-framework:
    runs-on: ubuntu-latest
    steps:
      - name: Check required configuration
        id: precheck
        shell: bash
        env:
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
          FRAMEWORK_REPO_SECRET: ${{ secrets.FRAMEWORK_REPO }}
          FRAMEWORK_REPO_VAR: ${{ vars.FRAMEWORK_REPO }}
        run: |
          repo_name="${FRAMEWORK_REPO_SECRET}"
          if [ -z "${repo_name}" ]; then
            repo_name="${FRAMEWORK_REPO_VAR}"
          fi

          missing=""
          if [ -z "${TOKEN}" ]; then
            missing="SPLIT_REPO_TOKEN"
          fi

          if [ -z "${repo_name}" ]; then
            if [ -n "${missing}" ]; then
              missing="${missing}, "
            fi
            missing="${missing}FRAMEWORK_REPO (secret or variable)"
          fi

          if [ -n "${missing}" ]; then
            echo "Missing ${missing}; skipping framework sync."
            echo "should_run=false" >> "${GITHUB_OUTPUT}"
            echo "repo_name=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "should_run=true" >> "${GITHUB_OUTPUT}"
          echo "repo_name=${repo_name}" >> "${GITHUB_OUTPUT}"

      - name: Checkout monorepo
        if: steps.precheck.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Split and push framework history
        if: steps.precheck.outputs.should_run == 'true'
        shell: bash
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          REPO_NAME: ${{ steps.precheck.outputs.repo_name }}
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
        run: |
          set -euo pipefail
          split_sha="$(git subtree split --prefix=framework)"
          git push --force "https://x-access-token:${TOKEN}@github.com/${REPO_NAME}.git" "${split_sha}:refs/heads/${BRANCH_NAME}"

  sync-macros:
    runs-on: ubuntu-latest
    steps:
      - name: Check required configuration
        id: precheck
        shell: bash
        env:
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
          MACROS_REPO_SECRET: ${{ secrets.MACROS_REPO }}
          MACROS_REPO_VAR: ${{ vars.MACROS_REPO }}
          DEPENDENCIES_REPO_SECRET: ${{ secrets.DEPENDENCIES_REPO }}
          DEPENDENCIES_REPO_VAR: ${{ vars.DEPENDENCIES_REPO }}
        run: |
          macros_repo="${MACROS_REPO_SECRET}"
          if [ -z "${macros_repo}" ]; then
            macros_repo="${MACROS_REPO_VAR}"
          fi

          dependencies_repo="${DEPENDENCIES_REPO_SECRET}"
          if [ -z "${dependencies_repo}" ]; then
            dependencies_repo="${DEPENDENCIES_REPO_VAR}"
          fi

          repo_name="${macros_repo}"
          if [ -z "${repo_name}" ]; then
            repo_name="${dependencies_repo}"
          fi

          missing=""
          if [ -z "${TOKEN}" ]; then
            missing="SPLIT_REPO_TOKEN"
          fi

          if [ -z "${repo_name}" ]; then
            if [ -n "${missing}" ]; then
              missing="${missing}, "
            fi
            missing="${missing}MACROS_REPO or DEPENDENCIES_REPO (secret or variable)"
          fi

          if [ -n "${missing}" ]; then
            echo "Missing ${missing}; skipping macro sync."
            echo "should_run=false" >> "${GITHUB_OUTPUT}"
            echo "repo_name=" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "should_run=true" >> "${GITHUB_OUTPUT}"
          echo "repo_name=${repo_name}" >> "${GITHUB_OUTPUT}"

      - name: Checkout monorepo
        if: steps.precheck.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Split and push macro pack history
        if: steps.precheck.outputs.should_run == 'true'
        shell: bash
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          REPO_NAME: ${{ steps.precheck.outputs.repo_name }}
          TOKEN: ${{ secrets.SPLIT_REPO_TOKEN }}
        run: |
          set -euo pipefail
          split_sha="$(git subtree split --prefix=macro_packs/default)"
          git push --force "https://x-access-token:${TOKEN}@github.com/${REPO_NAME}.git" "${split_sha}:refs/heads/${BRANCH_NAME}"
